
@{
    ViewBag.Title = "TrainingView";
    Layout = "~/Views/Shared/_Layout.cshtml";
    DataLibrary.Entities.User currentUser = Session["CurrentUser"] as DataLibrary.Entities.User;
}

<style>


    #popUp {
        padding-block: 10px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #ffffff;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        
    }

    #viewingPrerequisites {
        background-color: #ffffff;
        padding: 10px;
        border-radius: 8px;
        margin: 20px;
    }

    #trainingTable {
        background-color: #ffffff;
        padding: 10px;
        border-radius: 8px;
        margin: 20px;
    }

        #trainingTable table {
            border-collapse: collapse;
            width: 100%;
        }

        #trainingTable th, #trainingTable td {
            padding: 10px;
            text-align: left;
            border: 1px solid #b2dfdb;
            border-radius: 5px;
        }

        #trainingTable th {
            background-color: #e0f2f1;
            color: #000000;
        }

        #trainingTable tbody tr {
            background-color: #ffffff;
        }

            #trainingTable tbody tr:nth-child(even) {
                background-color: #ccffff;
            }

            #trainingTable tbody tr:nth-child(odd) {
                background-color: #ffffff;
            }
</style>


<script>
    $(document).ready(function () {

        function formatDateTime(date) {
            if (date) {
                var parsedDate = new Date(parseInt(date.substr(6)));
                return parsedDate.toLocaleDateString() + ' ' + parsedDate.toLocaleTimeString();
            } else {
                return 'No date';
            }
        }

        function getAJAXCall(URL) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: "GET",
                    url: URL,
                    data: null,
                    dataType: "json",
                    success: function (data) {
                        resolve(data);
                    },
                    error: function (data) {
                        reject(data);
                    }
                })
            });
        }

        //function to populate Table
         function populateTable() {
            var URL = "/Training/getAll";
            getAJAXCall(URL).then((response) => {
                if (response) {
                    console.log(response);
                    var tableBody = $("#trainingTable tbody");
                    tableBody.empty();
                    $.each(response, function (index, training) {
                        var row = '<tr>' +
                            '<td>' + training.TrainingID + '</td>' +
                            '<td>' + training.TrainingName + '</td>' +
                            '<td>' + training.Capacity + '</td>' +
                            '<td>' + formatDateTime(training.ClosingDate) + '</td>' +
                            '<td>' + training.TrainingStatus + '</td>' +
                            '<td>' + formatDateTime(training.TrainingStartDate) + '</td>' +
                            '<td> <button id ="viewPrerequisites" value = "' + training.TrainingID + '" > View Prerequisites </button> </td>' +
                            '</tr>';
                        tableBody.append(row);
                    });
                }
            }).catch((error) => {
                console.error(error);
                toastr.error("error cannot load data");
            });
        }

        //function to be triggered when clicking on view prerequisites button 
        $("#trainingTable tbody").on("click", "#viewPrerequisites", function () {
            var URL = "/Training/GetPrerequisites";
            var row = $(this).closest("tr");
            var trainingID = $(this).val();
            var trainingobj = { trainingID: trainingID }
            var serverCall = new ServerCall({ url: URL, parameters: trainingobj, callMethod: "POST" });
            serverCall.fetchApiCall().then((response) => {
                if (response) {
                    //populate popup
                    response.result.forEach(function (p) {
                        var paragraph = document.createElement('p');
                        paragraph.textContent = 'Prerequisites Needed : ' + p.Details;
                        $('div#popupText').append(paragraph);
                    });

                    //Access value within the clicked row
                    var clickedTrainingName = row.find("td:eq(1)").text();
                    $('div#trainingName').text("Training prerequisites for : " + clickedTrainingName);
                    $('div#trainingTable').fadeOut();
                    $('div#popup').fadeIn(1000);
                }
                else {
                    toastr.error("error loading table");
                }
            });
        });

        //close popup view prerequisites
        $(document).on("click", "button#closebtn", function (e) {
            $('div#trainingName').text('');
            $('div#popupText').text('');
            $('div#popup').fadeOut();
            $('div#trainingTable').fadeIn();
        })

        function testFunction() {
            var URL = "/Training/GetAllTrainingWithPrerequisitesAndDepartments";
            getAJAXCall(URL).then((response) => {
                console.log(response);
                alert(JSON.stringify(response));
            });
        }


        //General flow
        populateTable();
        testFunction();
    });

</script>



<!-- rendered Body -->
<div id="second-container">
    <div id="trainingTable">
        <table id="trainingTable" border="1">
            <thead>
                <tr>
                    <th>Training ID</th>  <!--If you are changing this structure remember to change the function where dealing with <td> when viewing prerequisites-->
                    <th>Training Name</th>
                    <th>Capacity</th>
                    <th>Closing Date</th>
                    <th>Training Status</th>
                    <th>Training Start Date</th>
                    <th>Prerequisites</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table body will be populated dynamically -->
            </tbody>
        </table>
        <span id="info"></span>
    </div>

    <div id="popup" style="display: none;">
        <div id="trainingName"></div>
        <div id="popupText"></div>
        <div><button id="closebtn">Close</button></div>
    </div>
</div>